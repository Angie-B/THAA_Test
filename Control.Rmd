---
title: "Targeted MSDial Pipeline"
author: "RLionheart"
date: "12/26/2019"
output: html_document
---

TODO
- Figure out data_processed subdirectory creation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(anytime)
library(rlist)
library(tidyverse)
library(tidyr)
options(scipen=999)

source("src/Functions.R")
```

This script controls the full targeted pipeline for Cyano and HILIC data that have been run through the MSDial metabolomics software.

It contains four major sections:
Section I: Import and cleaning/rearranging of data.
Section II: Quality control using user-defined parameters.
Section III: Applying Best-Matched Internal Standard (B-MIS).
Section IV: Quantifying peak area to umol/vial when possible.

--------------------------------------------------------------

Section I: Import all MSDial files that have been split by Area, Mass/charge (Mz), Retention Time (RT), and Signal to Noise (SN).

*Action required*
Set patterns for matching Cyano or HILIC data.

Steps to import files
1. For the file.patten variable, enter a pattern that will apply only to the files you want from the working directory.
2. For the matching.pattern variable, comment or uncomment the correct line whether you are running HILIC or Cyano data.

```{r, include=FALSE}
# Cyano
file.pattern <- "CYANO"
matching.pattern <- "RP.Cyano"

# HILIC
# file.pattern <- "HILIC"
# matching.pattern <- "positive|negative" 
```

```{r, include=FALSE}
source("src/MSDial_Import.R")
```

*Action required*
Steps to import files continued

3. In the Assign filenames here section, comment or uncomment the block of variable names appropriate for your run.
```{r, include=FALSE}
# Comment out the run not being used.

# Cyano variables: 
Area.RP.Cyano <- Area_CYANO_EddyTransect
Mz.RP.Cyano   <- Mz_CYANO_EddyTransect
RT.RP.Cyano   <- RT_CYANO_EddyTransect
SN.RP.Cyano   <- SN_CYANO_EddyTransect

# HILIC variables: 
# Area.positive <- Area_HILICPos_Example
# Mz.positive   <- Mz_HILICPos_Example
# RT.positive   <- RT_HILICPos_Example
# SN.positive   <- SN_HILICPos_Example
# 
# Area.negative <- Area_HILICNeg_Example
# Mz.negative   <- Mz_HILICNeg_Example
# RT.negative   <- RT_HILICNeg_Example
# SN.negative   <- SN_HILICNeg_Example

```

Inputs: 
Area, Mz, RT and SN datasets as defined in the previous step, existing in the global environment.
Outputs: 
"data_processed/MSDial_combined_*file.pattern*_*DATE*.csv"
```{r, include=FALSE}
source("src/MSDial_Rearrange.R")
```

--------------------------------------------------------------

Section II: Quality Control and flagging of problematic peaks.

*Action required*

Define parameters for quality control. These will change depending on whether you are analyzing HILIC or Cyano data.
```{r, include=FALSE}
area.min   <- 1000
RT.flex    <- 0.4
blk.thresh <- 0.3
SN.min     <- 4
```

Inputs: 
"data_processed/MSDial_combined_*file.pattern*_*DATE*.csv"
Outputs: 
"data_processed/MSDial_QC_Output_*file.pattern*_*DATE*.csv"
```{r, include=FALSE}
source("src/MSDial_QC.R")
```

--------------------------------------------------------------

Section III: Best-Matched Internal Standard (B-MIS)

*Action required*

Enter user data for cut off parameters.
cut.off = Decrease in RSD of pooled injections, aka improvement cutoff.
cut.off2 = Relative squared deviation minimum.

Comment out appropriate variable blocks according to HILIC or Cyano data.
```{r, include = FALSE}
cut.off <- 0.4 
cut.off2 <- 0.1 

# Cyano
Column.Type = "RP"
standards.pattern = "Ingalls"
QC.pattern = "QC_Output_CYANO"

# HILIC
# Column.Type = "HILIC"
# sample.key.pattern = "HILIC"
# standards.pattern = "Ingalls"
# QC.pattern = "QC_Output_HILIC"

```

Inputs:
"data_extras/*Sample_Key_from_instrument*.csv"
"data_extras/Ingalls_Lab_Standards.csv"
"data_processed/MSDial_QC_Output_*file.pattern*_*DATE*.csv"

```{r, include = FALSE}
source("src/MSDial_BMIS.R")
```



If data is HILIC, identify duplicates and decide which to remove 
IdentifyDuplicates function will confirm if instrument column data exists.
User will need to use best judgement to decide which duplicate to remove.